<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Infos</title>
    <link rel="stylesheet" href="CSS/admin-staff_perinfo.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Jockey+One&display=swap" rel="stylesheet">
</head>
<body>
    <div class="header">
        <div class="logo-container">
            <img src="img/logo.png" alt="Logo" class="logo">
            <div class="title">ALAMS </div>
        </div>
        <div class="admin-menu">
            <span>ADMIN</span>
            <i class="fa-solid fa-caret-down"></i>
            <div class="dropdown">
                <button class="logout-btn">Logout</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <a href="admin-dashboard.html" class="menu-item"><i class="fa-solid fa-house"></i> Dashboard</a>
            <a href="admin-register.html" class="menu-item"><i class="fa-solid fa-qrcode" style="color: #ffffff;"></i>Registration</a>
            <a href="admin-scanner.html" class="menu-item"><i class="fa-solid fa-expand"></i> Scanner</a>
            <a href="admin-students_attendance.html" class="menu-item"><i class="fa-solid fa-clipboard" style="color: #ffffff;"></i>Attendances</a>
            <a href="admin-student_perinfo.html" class="menu-item"><i class="fa-solid fa-user"></i>Personal Information</a>
            <a href="admin-user.html" class="menu-item "><i class="fa-solid fa-user-gear"></i> User Management</a>
        </div>

        <div class="dashboard">
            <div class="tabs-container">
                <a href="admin-student_perinfo.html" class="tab">Student</a>
                <a href="admin-faculty_perinfo.html" class="tab">Faculty</a>
                <a href="admin-staff_perinfo.html" class="tab">Staff</a>
            </div>
            <h1>Staff Information</h1>

            <div class="content-container">
                <div class="search-container">
                    <input type="text" class="search-box" placeholder="Search staff...">
                    <div class="button-group">
                        <button class="add-file-btn"><i class="fa-solid fa-file-import"></i>Add File</button>
                        <button class="add-user-btn"><i class="fa-solid fa-plus"></i>Add Staff</button>
                    </div>
                </div>

                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Staff Number</th>
                            <th>Picture</th>
                            <th>
                                Pincode
                            </th>
                            <th>Name</th>
                            <th>
                                Department
                                <select id="department-filter" class="filter-select">
                                    <option value="">All Departments</option>
                                </select>
                            </th>
                            <th>
                                Role
                                <select id="role-filter" class="filter-select">
                                    <option value="">All Roles</option>
                                </select>
                            </th>
                            <th>
                                Registration
                                <select id="registration-filter" class="filter-select">
                                    <option value="">All</option>
                                    <option value="Registered">Registered</option>
                                    <option value="Unregistered">Unregistered</option>
                                </select>
                            </th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Staff data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal">
        <div class="modal-content">
            Are you sure you want to logout?
            <div class="modal-buttons">
                <button class="yes-btn">Yes</button>
                <button class="no-btn">No</button>
            </div>
        </div>
    </div>

    <div class="add-user-modal">
    <div class="add-user-form">
        <div class="form-header">
            <div class="form-title"> <i class="fa-solid fa-plus"></i>Add Staff Information</div>
            <button class="close-btn">&times;</button>
        </div>
        <form id="add-staff-form">
            <div class="form-group">
                <label for="staff-number">Staff Number:</label>
                <input type="number" id="staff-number" required>
            </div>
            <div class="form-group">
                <label for="staff-name">Name:</label>
                <input type="text" id="staff-name" placeholder="Full Name" required>
            </div>
            <div class="form-group">
                <label for="staff-department">Department:</label>
                <select id="staff-department" required>
                    <option value="" disabled selected>Select Department</option>
                </select>
            </div>
            <div class="form-group">
                <label for="staff-role">Role:</label>
                <select id="staff-role" required>
                    <option value="" disabled selected>Select Role</option>
                </select>
            </div>
            <div class="picture-upload-section">
                <label>Picture:</label>
                <div class="picture-preview" id="picture-preview">
                    <i class="fa-solid fa-user picture-placeholder" id="picture-placeholder"></i>
                </div>
                <div class="picture-buttons">
                    <button type="button" class="choose-picture-btn" onclick="document.getElementById('staff-picture').click()">
                        Choose Picture
                    </button>
                    <button type="button" class="remove-picture-btn" id="remove-picture-btn">
                        Remove Picture
                    </button>
                </div>
                <input type="file" id="staff-picture" accept="image/*">
            </div>
            
            <div class="pin-code-section">
                <label>Pin Code:</label>
                <input type="text" class="pin-code-input" id="staff-pincode" placeholder="" readonly>
                <button type="button" class="generate-pin-btn" id="generate-pin-btn">
                    <i class="fa-solid fa-refresh"></i>
                    Generate New PIN
                </button>
            </div>
            
            <div class="form-group">
                <label for="staff-registration" style="text-align: left; display: block;">Registration Status:</label>
                <div class="role-display" id="staff-registration">Unregistered</div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="cancel-btn">Cancel</button>
                <button type="button" class="save-btn">Save</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    logPageAccess();

    const adminMenu = document.querySelector(".admin-menu");
    const dropdown = document.querySelector(".dropdown");

    adminMenu.addEventListener("click", function (event) {
        event.stopPropagation();
        dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
    });

    document.addEventListener("click", function () {
        dropdown.style.display = "none";
    });
    
    // Logout modal functionality
    const logoutBtn = document.querySelector(".logout-btn");
    const logoutModal = document.querySelector(".modal");
    const yesBtn = document.querySelector(".yes-btn");
    const noBtn = document.querySelector(".no-btn");

    logoutBtn.addEventListener("click", function () {
        logoutModal.style.display = "flex";
    });

    yesBtn.addEventListener("click", function () {
        window.location.href = "login.html";
    });

    noBtn.addEventListener("click", function () {
        logoutModal.style.display = "none";
    });
    
    // Department and role data
    const departmentsData = {
        "Library": { roles: ["Librarian", "Assistant Librarian"] },
        "Registrar": { roles: ["Registrar", "Assistant Registrar"] },
        "IT Department": { roles: ["IT Manager", "Support Staff"] },
        "Finance": { roles: ["Accountant", "Finance Assistant"] },
        "Human Resources": { roles: ["HR Manager", "HR Assistant"] }
    };

        function logAuditTrail(action, description) {
        const formData = new FormData();
        formData.append('action', 'log_audit_trail');
        formData.append('audit_action', action);
        formData.append('description', description);

        fetch('PHP/audit_functions.php', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status !== 'success') {
                console.error('Failed to log audit trail:', data.message);
            }
        })
        .catch(error => {
            console.error('Error logging audit trail:', error);
        });
    }

    // Function to log page access
    function logPageAccess() {
        logAuditTrail('PERSONAL_INFO_ACCESS', 'Accessed staff personal information page');
    }
    
    // Filter elements
    const departmentFilter = document.getElementById('department-filter');
    const roleFilter = document.getElementById('role-filter');
    const registrationFilter = document.getElementById('registration-filter');
    
    // Initialize filter dropdowns
    function initializeFilters() {
        departmentFilter.innerHTML = '<option value="">All Departments</option>';
        Object.keys(departmentsData).forEach(dept => {
            const option = document.createElement("option");
            option.value = dept;
            option.textContent = dept;
            departmentFilter.appendChild(option);
        });

        departmentFilter.addEventListener('change', function() {
            const selectedDept = this.value;
            updateRoleFilter(selectedDept);
            applyFilters();
        });

        roleFilter.addEventListener('change', applyFilters);
        registrationFilter.addEventListener('change', applyFilters);
    }
    
    // Update role filter based on selected department
    function updateRoleFilter(department) {
        roleFilter.innerHTML = '<option value="">All Roles</option>';
        
        if (department && departmentsData[department]) {
            const roles = departmentsData[department].roles;
            roles.forEach(role => {
                const option = document.createElement("option");
                option.value = role;
                option.textContent = role;
                roleFilter.appendChild(option);
            });
        } else {
            Object.values(departmentsData).forEach(dept => {
                dept.roles.forEach(role => {
                    if (!Array.from(roleFilter.options).some(option => option.value === role)) {
                        const option = document.createElement("option");
                        option.value = role;
                        option.textContent = role;
                        roleFilter.appendChild(option);
                    }
                });
            });
        }
    }
    
    initializeFilters();
    
    // Load staff data with optional filters
    function loadStaffData() {
        const searchValue = document.querySelector(".search-box").value.trim();
        const deptValue = departmentFilter.value;
        const roleValue = roleFilter.value;
        const registrationValue = registrationFilter.value;
        
        let url = 'PHP/admin-staff_perinfo.php';
        let params = [];
        
        if (searchValue) params.push(`search=${encodeURIComponent(searchValue)}`);
        if (deptValue) params.push(`department=${encodeURIComponent(deptValue)}`);
        if (roleValue) params.push(`role=${encodeURIComponent(roleValue)}`);
        if (registrationValue) params.push(`registration_status=${encodeURIComponent(registrationValue)}`);
        
        if (params.length > 0) url += '?' + params.join('&');
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    displayStaffData(data.data);
                } else {
                    console.error('Error loading staff data:', data.message);
                    alert('Error loading staff data: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                const mockData = [];
                displayStaffData(mockData);
            });
    }

    // Generate pincode for staff
    function generatePincode(staffId) {
        const pincode = Math.floor(100000 + Math.random() * 900000).toString();
        
        fetch('PHP/admin-staff_perinfo.php', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: staffId, pincode: pincode })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Pincode generated successfully');
                loadStaffData();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error connecting to the server. Please try again later.');
        });
    }
    
    // Display staff data in table
    function displayStaffData(staffData) {
        const tbody = document.querySelector(".user-table tbody");
        tbody.innerHTML = '';
        
        if (staffData.length === 0) {
            const emptyRow = document.createElement("tr");
            emptyRow.innerHTML = `<td colspan="8" style="text-align: center; font-weight: bold;">No staff records found</td>`;
            tbody.appendChild(emptyRow);
            return;
        }
        
        staffData.forEach(staff => {
            const newRow = document.createElement("tr");
            newRow.dataset.id = staff.id;
            newRow.innerHTML = `
                <td>${staff.staff_number}</td>
                <td>
                    ${staff.picture ? 
                        `<img src="${staff.picture}" alt="Profile" class="profile-pic">` : 
                        `<div class="no-picture"><i class="fa-solid fa-user"></i></div>`
                    }
                </td>
                <td>${staff.pincode || 'Not set'}</td>
                <td>${staff.name}</td>
                <td>${staff.department}</td>
                <td>${staff.role}</td>
                <td>
                    <span style="color: ${staff.registration_status === 'Registered' ? 'green' : 'red'}; font-weight: bold;">
                        ${staff.registration_status}
                    </span>
                </td>
                <td>
                    <i class="fa-solid fa-edit edit-btn" data-id="${staff.id}" style="color: #8869BB; margin-right: 10px; cursor: pointer;"></i>
                </td>
            `;
            tbody.appendChild(newRow);
        });
        
        setupActionButtons();
    }
    
    function applyFilters() {
        loadStaffData();
    }

    // Add staff button functionality
    const addStaffBtn = document.querySelector(".add-user-btn");
    const addUserModal = document.querySelector(".add-user-modal");
    const closeModalBtn = document.querySelector(".close-btn");
    const cancelBtn = document.querySelector(".cancel-btn");
    const formTitle = document.querySelector(".form-title");
    
    addStaffBtn.addEventListener("click", function(e) {
        e.preventDefault();
        e.stopPropagation();

        logAuditTrail('ADD_STAFF', 'Opened add staff modal');
        
        formTitle.textContent = "Add Staff Information";
        addUserModal.style.display = "block";
        
        const staffDepartment = document.querySelector("#staff-department");
        staffDepartment.innerHTML = '<option value="" disabled selected>Select Department</option>';
        Object.keys(departmentsData).forEach(dept => {
            const option = document.createElement("option");
            option.value = dept;
            option.textContent = dept;
            staffDepartment.appendChild(option);
        });
        
        const newStaffDepartment = staffDepartment.cloneNode(true);
        staffDepartment.parentNode.replaceChild(newStaffDepartment, staffDepartment);
        
        newStaffDepartment.addEventListener("change", function() {
            const selectedDept = this.value;
            const roles = departmentsData[selectedDept]?.roles || [];
            const staffRole = document.querySelector("#staff-role");
            staffRole.innerHTML = '<option value="" disabled selected>Select Role</option>';
            roles.forEach(role => {
                const option = document.createElement("option");
                option.value = role;
                option.textContent = role;
                staffRole.appendChild(option);
            });
        });
        
        document.querySelector("#staff-number").value = "";
        document.querySelector("#staff-name").value = "";
        document.querySelector("#staff-registration").textContent = "Unregistered";
        document.querySelector("#staff-pincode").value = "";
        
        const picturePreview = document.querySelector("#picture-preview");
        const placeholder = document.querySelector("#picture-placeholder");
        const removePictureBtn = document.querySelector("#remove-picture-btn");
        const existingImg = picturePreview.querySelector('img');
        if (existingImg) existingImg.remove();
        
        placeholder.style.display = 'block';
        removePictureBtn.style.display = 'none';
        
        delete saveBtn.dataset.editRow;
        delete saveBtn.dataset.staffId;
    });

    // Modal close functionality
    closeModalBtn.addEventListener("click", function(e) {
        e.preventDefault();
        e.stopPropagation();
        addUserModal.style.display = "none";
    });

    cancelBtn.addEventListener("click", function(e) {
        e.preventDefault();
        e.stopPropagation();
        addUserModal.style.display = "none";
    });

    // Save staff data
    const saveBtn = document.querySelector(".save-btn");
    
    saveBtn.addEventListener("click", function() {
        const staffNumber = document.querySelector("#staff-number").value.trim();
        const name = document.querySelector("#staff-name").value.trim();
        const department = document.querySelector("#staff-department").value;
        const role = document.querySelector("#staff-role").value;
        const registration_status = document.querySelector("#staff-registration").textContent.trim();
        const pincode = document.querySelector("#staff-pincode").value.trim();
        const pictureInput = document.querySelector("#staff-picture");
        
        if (!staffNumber || !name || !department || !role) {
            alert("Please fill in all required fields.");
            return;
        }
        
        const staffData = {
            staff_number: staffNumber,
            name: name,
            department: department,
            role: role,
            registration_status: registration_status,
            pincode: pincode
        };
        
        if (pictureInput.files.length > 0) {
            const file = pictureInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                staffData.picture = e.target.result;
                saveStaffData(staffData);
            };
            
            reader.readAsDataURL(file);
        } else {
            saveStaffData(staffData);
        }
    });

    // Save staff data to server
    function saveStaffData(staffData) {
        if (saveBtn.dataset.staffId) {
            staffData.id = saveBtn.dataset.staffId;
            
            fetch('PHP/admin-staff_perinfo.php', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(staffData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Staff updated successfully');
                    loadStaffData();
                    addUserModal.style.display = "none";
                    document.querySelector("#add-staff-form").reset();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error connecting to the server. Please try again later.');
            });
        } else {
            staffData.registration_status = "Unregistered";
            
            fetch('PHP/admin-staff_perinfo.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(staffData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Staff added successfully');
                    loadStaffData();
                    addUserModal.style.display = "none";
                    document.querySelector("#add-staff-form").reset();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error connecting to the server. Please try again later.');
            });
        }
    }

     const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
            const tabName = this.textContent.trim();
            logAuditTrail('SWITCH_TAB', `Switched to ${tabName} personal information tab`);
        });
    });
    
    // Setup action buttons (edit only)
        function setupActionButtons() {
            const editButtons = document.querySelectorAll('.edit-btn');
            
            editButtons.forEach(button => {
                // Remove any existing event listeners to prevent duplicates
                button.replaceWith(button.cloneNode(true));
            });
            
            // Re-select the buttons after cloning
            const newEditButtons = document.querySelectorAll('.edit-btn');
            
            newEditButtons.forEach(button => {
                button.addEventListener('click', function() {
                    console.log('Edit button clicked'); // Debug line
                    
                    const row = this.closest('tr');
                    const staffId = row.dataset.id;
                    const staffName = row.cells[3].textContent;
                    logAuditTrail('EDIT_STAFF_INFO', `Editing staff information: ${staffName}`);
                    
                    
                    const staffNumber = row.cells[0].textContent;
                    const name = row.cells[3].textContent;
                    const department = row.cells[4].textContent;
                    const role = row.cells[5].textContent;
                    const registration = row.cells[6].textContent.trim();
                    const pincode = row.cells[2].textContent;
                    
                    console.log('Editing staff:', staffId, name); // Debug line
                    
                    // Populate form fields
                    document.querySelector("#staff-number").value = staffNumber;
                    document.querySelector("#staff-name").value = name;
                    document.querySelector("#staff-registration").textContent = registration;
                    document.querySelector("#staff-pincode").value = pincode === 'Not set' ? '' : pincode;
                    
                    // Populate department dropdown
                    const staffDepartment = document.querySelector("#staff-department");
                    staffDepartment.innerHTML = '<option value="" disabled>Select Department</option>';
                    Object.keys(departmentsData).forEach(dept => {
                        const option = document.createElement("option");
                        option.value = dept;
                        option.textContent = dept;
                        if (dept === department) {
                            option.selected = true;
                        }
                        staffDepartment.appendChild(option);
                    });
                    
                    // Populate role dropdown based on selected department
                    const staffRole = document.querySelector("#staff-role");
                    staffRole.innerHTML = '<option value="" disabled>Select Role</option>';
                    if (departmentsData[department]) {
                        departmentsData[department].roles.forEach(roleOption => {
                            const option = document.createElement("option");
                            option.value = roleOption;
                            option.textContent = roleOption;
                            if (roleOption === role) {
                                option.selected = true;
                            }
                            staffRole.appendChild(option);
                        });
                    }
                    
                    // Handle picture display
                    const pictureCell = row.cells[1];
                    const imgElement = pictureCell.querySelector('img');
                    const picturePreview = document.querySelector("#picture-preview");
                    const placeholder = document.querySelector("#picture-placeholder");
                    const removePictureBtn = document.querySelector("#remove-picture-btn");
                    
                    // Clear existing image
                    const existingImg = picturePreview.querySelector('img');
                    if (existingImg) {
                        existingImg.remove();
                    }
                    
                    if (imgElement && imgElement.src) {
                        // Create new image element
                        const img = document.createElement('img');
                        img.src = imgElement.src;
                        img.style.width = '100%';
                        img.style.height = '100%';
                        img.style.objectFit = 'cover';
                        img.style.borderRadius = '50%';
                        picturePreview.appendChild(img);
                        placeholder.style.display = 'none';
                        removePictureBtn.style.display = 'inline-block';
                    } else {
                        placeholder.style.display = 'block';
                        removePictureBtn.style.display = 'none';
                    }
                    
                    // Update form title and show modal
                    document.querySelector(".form-title").textContent = "Edit Staff Information";
                    document.querySelector(".add-user-modal").style.display = "block";
                    
                    // Set the staff ID for the update operation
                    document.querySelector(".save-btn").dataset.staffId = staffId;
                    
                    console.log('Modal should be visible now'); // Debug line
                });
            });
        }

    // Picture handling functionality
    document.getElementById('remove-picture-btn').addEventListener('click', function() {
        const pictureInput = document.getElementById('staff-picture');
        const preview = document.getElementById('picture-preview');
        const placeholder = document.getElementById('picture-placeholder');
        const removePictureBtn = document.getElementById('remove-picture-btn');
        
        pictureInput.value = '';
        
        const img = preview.querySelector('img');
        if (img) img.remove();
        
        placeholder.style.display = 'block';
        removePictureBtn.style.display = 'none';
    });    

            // File upload functionality - CSV ONLY
        const addFileBtn = document.querySelector(".add-file-btn");
        const fileUploadModal = document.createElement("div");
        fileUploadModal.className = "file-upload-modal";
        fileUploadModal.innerHTML = `
            <div class="file-upload-form">
                <div class="file-upload-header">
                    <div class="file-upload-title"><i class="fa-solid fa-file-import"></i> Staff Personal Information</div>
                    <button class="close-upload-btn">&times;</button>
                </div>
                
                <div class="file-upload-instructions">
                    <h4>File Requirements:</h4>
                    <ul>
                        <li>File format: CSV only</li>
                        <li>Required columns: Staff Number, Name, Department, Role</li>
                        <li>Optional columns: Pincode (6 digits)</li>
                        <li>Maximum file size: 5MB</li>
                        <li>First row should contain column headers</li>
                    </ul>
                </div>
                
                <div class="file-upload-area" id="file-upload-area">
                    <i class="fa-solid fa-cloud-upload-alt"></i>
                    <div class="file-upload-text">Click to upload or drag and drop</div>
                    <div class="file-upload-hint">CSV files only</div>
                    <input type="file" id="staff-file" class="file-input" accept=".csv">
                </div>
                
                <div class="upload-preview" id="upload-preview">
                    <h4>File Preview (First 5 rows):</h4>
                    <div id="preview-table"></div>
                </div>
                
                <div class="upload-actions">
                    <button class="cancel-upload-btn">Cancel</button>
                    <button class="upload-btn" id="upload-btn" disabled>Upload File</button>
                </div>
            </div>
        `;

        document.body.appendChild(fileUploadModal);

        // File upload event listeners
        addFileBtn.addEventListener("click", function() {
            logAuditTrail('ADD_FILE_STAFF', 'Opened file upload modal for staff data');
            fileUploadModal.style.display = "flex";
        });

        document.querySelector(".close-upload-btn").addEventListener("click", function() {
            fileUploadModal.style.display = "none";
            resetFileUpload();
        });

        document.querySelector(".cancel-upload-btn").addEventListener("click", function() {
            fileUploadModal.style.display = "none";
            resetFileUpload();
        });

        // File upload area functionality
        const fileUploadArea = document.getElementById("file-upload-area");
        const fileInput = document.getElementById("staff-file");
        const uploadPreview = document.getElementById("upload-preview");
        const previewTable = document.getElementById("preview-table");
        const uploadBtn = document.getElementById("upload-btn");

        fileUploadArea.addEventListener("click", function() {
            fileInput.click();
        });

        fileUploadArea.addEventListener("dragover", function(e) {
            e.preventDefault();
            fileUploadArea.style.backgroundColor = "#e9ecef";
        });

        fileUploadArea.addEventListener("dragleave", function() {
            fileUploadArea.style.backgroundColor = "";
        });

        fileUploadArea.addEventListener("drop", function(e) {
            e.preventDefault();
            fileUploadArea.style.backgroundColor = "";
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelection(files[0]);
            }
        });

        fileInput.addEventListener("change", function(e) {
            if (e.target.files.length > 0) {
                handleFileSelection(e.target.files[0]);
            }
        });

        function handleFileSelection(file) {
            // Only accept CSV files
            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert('Please select a CSV file only. Excel files are not supported.');
                return;
            }
            
            if (!file.type.includes('csv') && file.type !== 'text/csv') {
                alert('Please select a valid CSV file.');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB.');
                return;
            }
            
            previewFile(file);
        }

        function previewFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                parseCSV(e.target.result);
            };
            
            reader.readAsText(file);
        }

        function parseCSV(csvText) {
            try {
                const rows = csvText.split('\n').filter(row => row.trim() !== '');
                if (rows.length === 0) {
                    alert('CSV file is empty');
                    return;
                }
                
                const headers = rows[0].split(',').map(header => header.trim());
                
                // Validate required columns
                const requiredColumns = ['Staff Number', 'Name', 'Department', 'Role'];
                const missingColumns = requiredColumns.filter(col => !headers.includes(col));
                
                if (missingColumns.length > 0) {
                    alert(`Missing required columns: ${missingColumns.join(', ')}`);
                    return;
                }
                
                const data = rows.slice(1, 6).map(row => {
                    const values = row.split(',').map(value => value.trim());
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = values[index] || '';
                    });
                    return obj;
                });
                
                displayPreview(headers, data);
                uploadBtn.disabled = false;
                uploadBtn.fileData = { type: 'csv', data: csvText, filename: 'staff_upload.csv' };
            } catch (error) {
                alert('Error parsing CSV file: ' + error.message);
                resetFileUpload();
            }
        }

        function displayPreview(headers, data) {
            let tableHTML = `<table><thead><tr>`;
            headers.forEach(header => {
                tableHTML += `<th>${header}</th>`;
            });
            tableHTML += `</tr></thead><tbody>`;
            
            data.forEach(row => {
                tableHTML += `<tr>`;
                headers.forEach(header => {
                    tableHTML += `<td>${row[header] || ''}</td>`;
                });
                tableHTML += `</tr>`;
            });
            
            tableHTML += `</tbody></table>`;
            previewTable.innerHTML = tableHTML;
            uploadPreview.style.display = 'block';
        }

        function resetFileUpload() {
            fileInput.value = '';
            uploadPreview.style.display = 'none';
            uploadBtn.disabled = true;
            delete uploadBtn.fileData;
        }

        // Upload functionality
        uploadBtn.addEventListener("click", function() {
            if (!uploadBtn.fileData) return;
            
            // For offline functionality, store data in localStorage
            if (!navigator.onLine) {
                const uploads = JSON.parse(localStorage.getItem('pendingStaffUploads') || '[]');
                uploads.push({
                    id: Date.now(),
                    type: uploadBtn.fileData.type,
                    data: uploadBtn.fileData.data,
                    filename: uploadBtn.fileData.filename,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('pendingStaffUploads', JSON.stringify(uploads));
                
                alert('File saved for upload when online. You can continue working offline.');
                fileUploadModal.style.display = "none";
                resetFileUpload();
                return;
            }
            
            const formData = new FormData();
            formData.append('action', 'bulk_upload');
            formData.append('file_type', uploadBtn.fileData.type);
            formData.append('file_data', uploadBtn.fileData.data);
            formData.append('filename', uploadBtn.fileData.filename);
            
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Uploading...';
            
            fetch('PHP/admin-staff_perinfo.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(`Successfully uploaded ${data.processed} staff records`);
                    fileUploadModal.style.display = "none";
                    resetFileUpload();
                    loadStaffData();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error uploading file. Please try again.');
            })
            .finally(() => {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = 'Upload File';
            });
        });

        // Handle offline/online status
        window.addEventListener('online', function() {
            // Process pending uploads when coming online
            const pendingUploads = JSON.parse(localStorage.getItem('pendingStaffUploads') || '[]');
            if (pendingUploads.length > 0) {
                processPendingUploads(pendingUploads);
            }
        });

        function processPendingUploads(uploads) {
            if (uploads.length === 0) return;
            
            const upload = uploads[0];
            const formData = new FormData();
            formData.append('action', 'bulk_upload');
            formData.append('file_type', upload.type);
            formData.append('file_data', upload.data);
            formData.append('filename', upload.filename);
            
            fetch('PHP/admin-staff_perinfo.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const remainingUploads = uploads.slice(1);
                    localStorage.setItem('pendingStaffUploads', JSON.stringify(remainingUploads));
                    
                    if (remainingUploads.length > 0) {
                        processPendingUploads(remainingUploads);
                    } else {
                        alert('All pending uploads completed successfully');
                        loadStaffData();
                    }
                }
            })
            .catch(error => {
                console.error('Error processing pending upload:', error);
            });
        }

    document.getElementById('staff-picture').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const preview = document.getElementById('picture-preview');
        const placeholder = document.getElementById('picture-placeholder');
        const removePictureBtn = document.getElementById('remove-picture-btn');
        
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                placeholder.style.display = 'none';
                
                let img = preview.querySelector('img');
                if (!img) {
                    img = document.createElement('img');
                    preview.appendChild(img);
                }
                img.src = e.target.result;
                img.style.display = 'block';
                
                removePictureBtn.style.display = 'inline-block';
            };
            reader.readAsDataURL(file);
        } else {
            const img = preview.querySelector('img');
            if (img) img.style.display = 'none';
            
            placeholder.style.display = 'block';
            removePictureBtn.style.display = 'none';
        }
    });
    
    // Pincode generation
    document.getElementById('generate-pin-btn').addEventListener('click', function() {
        const pincode = Math.floor(100000 + Math.random() * 900000).toString();
        document.getElementById('staff-pincode').value = pincode;
    });
    
    // Search functionality
    const searchBox = document.querySelector(".search-box");
    if (searchBox) {
        const newSearchBox = searchBox.cloneNode(true);
        searchBox.parentNode.replaceChild(newSearchBox, searchBox);
        
        newSearchBox.addEventListener("input", function() {
            clearTimeout(this.searchTimer);
            this.searchTimer = setTimeout(function() {
                 if (newSearchBox.value.length > 0) {
                logAuditTrail('SEARCH_PERSONAL_INFO', `Searched staff records: ${newSearchBox.value}`);
            }
                applyFilters();
            }, 300);
        });
        
        newSearchBox.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();

                if (this.value.length > 0) {
                logAuditTrail('SEARCH_PERSONAL_INFO', `Searched staff records: ${this.value}`);}
                applyFilters();
            }
        });
    }
    
    // Initial data load
    loadStaffData();
});
</script>
</body>
</html>